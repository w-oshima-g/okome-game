<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おこめゲーム</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="おこめゲーム">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-114.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" sizes="640x1136" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="750x1334" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="828x1792" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1125x2436" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2208" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2688" href="icons/icon-512.png">
    
    <!-- Disable zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <link rel="icon" type="image/png" href="icons/icon-57.png">
    <link rel="shortcut icon" type="image/png" href="icons/icon-57.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <!-- スイカゲーム風ヘッダー -->
        <div class="header">
            <div class="top-bar">
                <div class="circle-icon" id="bestScore">
                    <div class="icon-label">ベストスコア</div>
                    <div class="icon-value" id="bestScoreValue">0</div>
                </div>
                <div class="circle-icon" id="currentScore">
                    <div class="icon-label">スコア</div>
                    <div class="icon-value" id="score">0</div>
                </div>
                <div class="circle-icon" id="nextIcon">
                    <div class="icon-label">ネクスト</div>
                    <img id="nextImage" src="./image/okome1.png" alt="Next">
                </div>
                <div class="circle-icon" id="pauseIcon">
                    <div class="icon-symbol">⏸</div>
                </div>
                <div class="circle-icon" id="resetIcon">
                    <div class="icon-symbol">↻</div>
                </div>
                <div class="circle-icon" id="helpIcon">
                    <div class="icon-symbol">?</div>
                </div>
                <div class="circle-icon" id="musicIcon">
                    <div class="icon-symbol">♪</div>
                </div>
            </div>
        </div>
        
        <!-- メインゲームエリア -->
        <div class="game-area">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
        </div>
        
        <!-- PWA インストール促進バナー -->
        <div class="install-banner" id="installBanner" style="display: none;">
            <div class="install-content">
                <img src="./icons/icon-72.png" alt="おこめゲーム" class="install-icon">
                <div class="install-text">
                    <h3>おこめゲームをインストール</h3>
                    <p>ホーム画面に追加してアプリのように使おう！</p>
                </div>
                <div class="install-buttons">
                    <button id="installButton" class="install-btn-primary">インストール</button>
                    <button id="installDismiss" class="install-btn-secondary">後で</button>
                </div>
            </div>
        </div>
        <!-- ゲームオーバー画面 -->
        <div class="game-over" id="gameOver">
            <div>
                <h2>Game Over!</h2>
                <p>Final Score: <span id="finalScore">0</span></p>
                <button id="playAgainButton">Play Again</button>
            </div>
        </div>
        
        <!-- ヘルプポップアップ -->
        <div class="help-popup" id="helpPopup" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h2>成長の輪</h2>
                    <button class="help-close" id="helpClose">×</button>
                </div>
                <div class="help-body">
                    <p>同じレベルの犬を合体させて、どんどん成長させよう！</p>
                    <div class="growth-circle" id="helpGrowthCircle"></div>
                    <div class="help-tips">
                        <h3>遊び方</h3>
                        <ul>
                            <li>クリック/タップで犬をドロップ</li>
                            <li>同じレベルの犬同士がぶつかると合体</li>
                            <li>高レベルほど高スコア</li>
                            <li>赤い線を越えるとゲームオーバー</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 設定ポップアップ -->
        <div class="settings-popup" id="musicPopup" style="display: none;">
            <div class="settings-overlay"></div>
            <div class="settings-content">
                <button class="settings-close" id="musicClose">×</button>
                <h2>音量調整</h2>
                
                <!-- BGM選択セクション -->
                <div class="bgm-selection">
                    <h3>BGM選択</h3>
                    <div class="bgm-options">
                        <div class="bgm-option" data-bgm="1">
                            <div class="bgm-option-icon">🎵</div>
                            <div class="bgm-option-label">BGM 1</div>
                        </div>
                        <div class="bgm-option" data-bgm="2">
                            <div class="bgm-option-icon">🎶</div>
                            <div class="bgm-option-label">BGM 2</div>
                        </div>
                        <div class="bgm-option" data-bgm="3">
                            <div class="bgm-option-icon">🎼</div>
                            <div class="bgm-option-label">BGM 3</div>
                        </div>
                    </div>
                </div>
                
                <div class="volume-control">
                    <div class="volume-row">
                        <div class="volume-icon">♪</div>
                        <div class="volume-label">BGM</div>
                        <div class="volume-slider-container">
                            <input type="range" id="volumeSlider" min="0" max="100" value="25" class="volume-slider bgm-slider">
                        </div>
                        <button class="volume-mute-btn" id="bgmMuteBtn">🔊</button>
                    </div>
                    
                    <div class="volume-row">
                        <div class="volume-icon">🔊</div>
                        <div class="volume-label">SE</div>
                        <div class="volume-slider-container">
                            <input type="range" id="sfxVolumeSlider" min="0" max="100" value="30" class="volume-slider se-slider">
                        </div>
                        <button class="volume-mute-btn" id="seMuteBtn">🔊</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 隠しボタン（互換性のため） -->
        <button id="dropButton" style="display: none;">DROP</button>
        <button id="restartButton" style="display: none;">RESTART</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Service Worker登録（GitHub Pages対応）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = location.hostname.includes('github.io') ? '/okome-game/sw.js' : '/sw.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('ServiceWorker registration successful');
                        
                        // 更新チェック
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 新しいバージョンが利用可能
                                    if (confirm('新しいバージョンが利用可能です。更新しますか？')) {
                                        newWorker.postMessage({type: 'SKIP_WAITING'});
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
            
            // Service Worker更新時のリロード
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
        // PWAインストール促進
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const installDismiss = document.getElementById('installDismiss');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // デフォルトのバナーを防ぐ
            e.preventDefault();
            // 後で使うために保存
            deferredPrompt = e;
            // カスタムバナーを表示
            showInstallBanner();
        });
        
        function showInstallBanner() {
            // 既にインストール済みかチェック
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            
            // 以前に非表示にした場合は24時間後まで表示しない
            const lastDismissed = localStorage.getItem('installBannerDismissed');
            if (lastDismissed && Date.now() - parseInt(lastDismissed) < 24 * 60 * 60 * 1000) {
                return;
            }
            
            installBanner.style.display = 'block';
        }
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // iOS Safari用の手動インストール案内
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    alert('iOSでは、Safariメニューの「ホーム画面に追加」からインストールできます！');
                }
                return;
            }
            
            // インストールプロンプトを表示
            deferredPrompt.prompt();
            
            // ユーザーの応答を待つ
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            
            // プロンプトを使用済みにする
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
        
        installDismiss.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerDismissed', Date.now().toString());
        });
        
        // アプリがインストールされた時
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
            installBanner.style.display = 'none';
        });
        
        // ページ読み込み後少し遅れて表示（iOS Safari対応）
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    // BeforeInstallPromptイベントが発火しない場合（iOS Safari等）やテスト時
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad') || !deferredPrompt) {
                        console.log('Showing install banner - iOS or no deferredPrompt');
                        showInstallBanner();
                    }
                }
            }, 3000); // 3秒後に表示
        });
    </script>
</body>
</html>