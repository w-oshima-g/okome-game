<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠã“ã‚ã‚²ãƒ¼ãƒ </title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ãŠã“ã‚ã‚²ãƒ¼ãƒ ">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-114.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" sizes="640x1136" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="750x1334" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="828x1792" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1125x2436" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2208" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2688" href="icons/icon-512.png">
    
    <!-- Disable zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <link rel="icon" type="image/png" href="icons/icon-57.png">
    <link rel="shortcut icon" type="image/png" href="icons/icon-57.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <!-- ã‚¹ã‚¤ã‚«ã‚²ãƒ¼ãƒ é¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div class="top-bar">
                <div class="circle-icon" id="bestScore">
                    <div class="icon-label">ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</div>
                    <div class="icon-value" id="bestScoreValue">0</div>
                </div>
                <div class="circle-icon" id="currentScore">
                    <div class="icon-label">ã‚¹ã‚³ã‚¢</div>
                    <div class="icon-value" id="score">0</div>
                </div>
                <div class="circle-icon" id="nextIcon">
                    <div class="icon-label">ãƒã‚¯ã‚¹ãƒˆ</div>
                    <img id="nextImage" src="./image/okome1.png" alt="Next">
                </div>
                <div class="circle-icon" id="pauseIcon">
                    <div class="icon-symbol">â¸</div>
                </div>
                <div class="circle-icon" id="resetIcon">
                    <div class="icon-symbol">â†»</div>
                </div>
                <div class="circle-icon" id="helpIcon">
                    <div class="icon-symbol">?</div>
                </div>
                <div class="circle-icon" id="musicIcon">
                    <div class="icon-symbol">â™ª</div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div class="game-area">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
        </div>
        
        <!-- PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²ãƒãƒŠãƒ¼ -->
        <div class="install-banner" id="installBanner" style="display: none;">
            <div class="install-content">
                <img src="./icons/icon-72.png" alt="ãŠã“ã‚ã‚²ãƒ¼ãƒ " class="install-icon">
                <div class="install-text">
                    <h3>ãŠã“ã‚ã‚²ãƒ¼ãƒ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
                    <p>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãŠã†ï¼</p>
                </div>
                <div class="install-buttons">
                    <button id="installButton" class="install-btn-primary">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                    <button id="installDismiss" class="install-btn-secondary">å¾Œã§</button>
                </div>
            </div>
        </div>
        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
        <div class="game-over" id="gameOver">
            <div>
                <h2>Game Over!</h2>
                <p>Final Score: <span id="finalScore">0</span></p>
                <button id="playAgainButton">Play Again</button>
            </div>
        </div>
        
        <!-- ãƒ˜ãƒ«ãƒ—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div class="help-popup" id="helpPopup" style="display: none;">
            <div class="help-content">
                <div class="help-header">
                    <h2>æˆé•·ã®è¼ª</h2>
                    <button class="help-close" id="helpClose">Ã—</button>
                </div>
                <div class="help-body">
                    <p>åŒã˜ãƒ¬ãƒ™ãƒ«ã®çŠ¬ã‚’åˆä½“ã•ã›ã¦ã€ã©ã‚“ã©ã‚“æˆé•·ã•ã›ã‚ˆã†ï¼</p>
                    <div class="growth-circle" id="helpGrowthCircle"></div>
                    <div class="help-tips">
                        <h3>éŠã³æ–¹</h3>
                        <ul>
                            <li>ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§çŠ¬ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</li>
                            <li>åŒã˜ãƒ¬ãƒ™ãƒ«ã®çŠ¬åŒå£«ãŒã¶ã¤ã‹ã‚‹ã¨åˆä½“</li>
                            <li>é«˜ãƒ¬ãƒ™ãƒ«ã»ã©é«˜ã‚¹ã‚³ã‚¢</li>
                            <li>èµ¤ã„ç·šã‚’è¶Šãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- éŸ³æ¥½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div class="music-popup" id="musicPopup" style="display: none;">
            <div class="music-content">
                <div class="music-header">
                    <h2>BGMè¨­å®š</h2>
                    <button class="music-close" id="musicClose">Ã—</button>
                </div>
                <div class="music-body">
                    <div class="music-controls">
                        <div class="music-control-group">
                            <label>BGMé¸æŠ</label>
                            <select id="bgmSelect">
                                <option value="0">BGM 1 (åŸºæœ¬)</option>
                                <option value="1">BGM 2 (è»½å¿«)</option>
                                <option value="2">BGM 3 (è½ã¡ç€ã)</option>
                            </select>
                        </div>
                        <div class="music-control-group">
                            <label>éŸ³é‡: <span id="volumeValue">25</span>%</label>
                            <input type="range" id="volumeSlider" min="0" max="100" value="25">
                        </div>
                        <div class="music-control-group">
                            <button id="playPauseBtn" class="music-btn">â–¶ å†ç”Ÿ</button>
                            <button id="muteBtn" class="music-btn">ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- éš ã—ãƒœã‚¿ãƒ³ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰ -->
        <button id="dropButton" style="display: none;">DROP</button>
        <button id="restartButton" style="display: none;">RESTART</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Service Workerç™»éŒ²ï¼ˆGitHub Pageså¯¾å¿œï¼‰
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = location.hostname.includes('github.io') ? '/okome-game/sw.js' : '/sw.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('ServiceWorker registration successful');
                        
                        // æ›´æ–°ãƒã‚§ãƒƒã‚¯
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½
                                    if (confirm('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                                        newWorker.postMessage({type: 'SKIP_WAITING'});
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
            
            // Service Workeræ›´æ–°æ™‚ã®ãƒªãƒ­ãƒ¼ãƒ‰
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const installDismiss = document.getElementById('installDismiss');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒŠãƒ¼ã‚’é˜²ã
            e.preventDefault();
            // å¾Œã§ä½¿ã†ãŸã‚ã«ä¿å­˜
            deferredPrompt = e;
            // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
            showInstallBanner();
        });
        
        function showInstallBanner() {
            // æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            
            // ä»¥å‰ã«éè¡¨ç¤ºã«ã—ãŸå ´åˆã¯24æ™‚é–“å¾Œã¾ã§è¡¨ç¤ºã—ãªã„
            const lastDismissed = localStorage.getItem('installBannerDismissed');
            if (lastDismissed && Date.now() - parseInt(lastDismissed) < 24 * 60 * 60 * 1000) {
                return;
            }
            
            installBanner.style.display = 'block';
        }
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // iOS Safariç”¨ã®æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    alert('iOSã§ã¯ã€Safariãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼');
                }
                return;
            }
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
            deferredPrompt.prompt();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¿œç­”ã‚’å¾…ã¤
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
        
        installDismiss.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerDismissed', Date.now().toString());
        });
        
        // ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸæ™‚
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
            installBanner.style.display = 'none';
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œå°‘ã—é…ã‚Œã¦è¡¨ç¤ºï¼ˆiOS Safariå¯¾å¿œï¼‰
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    // BeforeInstallPromptã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„å ´åˆï¼ˆiOS Safariç­‰ï¼‰ã‚„ãƒ†ã‚¹ãƒˆæ™‚
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad') || !deferredPrompt) {
                        console.log('Showing install banner - iOS or no deferredPrompt');
                        showInstallBanner();
                    }
                }
            }, 3000); // 3ç§’å¾Œã«è¡¨ç¤º
        });
    </script>
</body>
</html>