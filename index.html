<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>おこめゲーム</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="おこめゲーム">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-114.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" sizes="640x1136" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="750x1334" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="828x1792" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1125x2436" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2208" href="icons/icon-512.png">
    <link rel="apple-touch-startup-image" sizes="1242x2688" href="icons/icon-512.png">
    
    <!-- Disable zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <link rel="icon" type="image/png" href="icons/icon-57.png">
    <link rel="shortcut icon" type="image/png" href="icons/icon-57.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>おこめゲーム</h1>
            <div class="score">Score: <span id="score">0</span></div>
        </div>
        <div class="game-area">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
            <div class="sidebar">
                <div class="next-preview">
                    <p>Next:</p>
                    <img id="nextImage" src="image/okome1.png" alt="Next">
                </div>
                <div class="growth-guide">
                    <h3>成長の輪</h3>
                    <div class="growth-circle" id="growthCircle"></div>
                </div>
            </div>
        </div>
        <div class="controls">
            <button id="dropButton">DROP</button>
            <button id="restartButton">RESTART</button>
        </div>
        
        <!-- PWA インストール促進バナー -->
        <div class="install-banner" id="installBanner" style="display: none;">
            <div class="install-content">
                <img src="icons/icon-72.png" alt="おこめゲーム" class="install-icon">
                <div class="install-text">
                    <h3>おこめゲームをインストール</h3>
                    <p>ホーム画面に追加してアプリのように使おう！</p>
                </div>
                <div class="install-buttons">
                    <button id="installButton" class="install-btn-primary">インストール</button>
                    <button id="installDismiss" class="install-btn-secondary">後で</button>
                </div>
            </div>
        </div>
        <div class="game-over" id="gameOver">
            <div>
                <h2>Game Over!</h2>
                <p>Final Score: <span id="finalScore">0</span></p>
                <button id="playAgainButton">Play Again</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="game.js"></script>
    <script>
        // Service Worker登録（GitHub Pages対応）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = location.hostname.includes('github.io') ? '/okome-game/sw.js' : '/sw.js';
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('ServiceWorker registration successful');
                        
                        // 更新チェック
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 新しいバージョンが利用可能
                                    if (confirm('新しいバージョンが利用可能です。更新しますか？')) {
                                        newWorker.postMessage({type: 'SKIP_WAITING'});
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
            
            // Service Worker更新時のリロード
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
        // PWAインストール促進
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const installDismiss = document.getElementById('installDismiss');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // デフォルトのバナーを防ぐ
            e.preventDefault();
            // 後で使うために保存
            deferredPrompt = e;
            // カスタムバナーを表示
            showInstallBanner();
        });
        
        function showInstallBanner() {
            // 既にインストール済みかチェック
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }
            
            // 以前に非表示にした場合は24時間後まで表示しない
            const lastDismissed = localStorage.getItem('installBannerDismissed');
            if (lastDismissed && Date.now() - parseInt(lastDismissed) < 24 * 60 * 60 * 1000) {
                return;
            }
            
            installBanner.style.display = 'block';
        }
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                // iOS Safari用の手動インストール案内
                if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                    alert('iOSでは、Safariメニューの「ホーム画面に追加」からインストールできます！');
                }
                return;
            }
            
            // インストールプロンプトを表示
            deferredPrompt.prompt();
            
            // ユーザーの応答を待つ
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            
            // プロンプトを使用済みにする
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
        
        installDismiss.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerDismissed', Date.now().toString());
        });
        
        // アプリがインストールされた時
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
            installBanner.style.display = 'none';
        });
        
        // ページ読み込み後少し遅れて表示（iOS Safari対応）
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    // BeforeInstallPromptイベントが発火しない場合（iOS Safari等）やテスト時
                    if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad') || !deferredPrompt) {
                        console.log('Showing install banner - iOS or no deferredPrompt');
                        showInstallBanner();
                    }
                }
            }, 3000); // 3秒後に表示
        });
    </script>
</body>
</html>